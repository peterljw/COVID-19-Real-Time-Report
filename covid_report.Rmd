---
title: "COVID-19 Analytical Report"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyquant)
library(tidyverse)
library(ggiraph)
library(covid19.analytics)
library(plotly)
library(nCov2019)
library(patchwork)
library(hrbrthemes)

Caps = function(x) {
  s <- strsplit(x, " ")[[1]]
  paste(toupper(substring(s, 1,1)), substring(s, 2),
        sep="", collapse=" ")
}
```

## 1. Data Preprocessing

### 1.1 Gloabl Confirmed Cases and Deaths Time-Series by Country

```{r message=FALSE}
 ts.confirmed = covid19.data("ts-confirmed")
 ts.confirmed =  ts.confirmed %>%
   group_by(Country.Region) %>%
   select(-c(Province.State, Lat, Long)) %>%
   summarise_all(funs(sum)) %>%
   arrange(desc(.[[ncol(ts.confirmed)-3]]))
 head(ts.confirmed)
 
ts.deaths = covid19.data("ts-deaths")
ts.deaths =  ts.deaths %>%
   group_by(Country.Region) %>%
   select(-c(Province.State, Lat, Long)) %>%
   summarise_all(funs(sum)) %>%
   arrange(desc(.[[ncol(ts.deaths)-3]]))
 head(ts.deaths)
```

### 1.2 U.S. Confirmed Cases and Deaths Time-Series By State

```{r message=FALSE}
nCov = load_nCov2019()
df.nCov = nCov$province
ts.us = df.nCov %>% filter(country == "United States") %>% 
  select("Date" = time, "State" = province, "Confirmed" = cum_confirm, "Deaths" = cum_dead)
ts.us$State = sapply(ts.us$State, Caps)
head(ts.us)
```

### 1.3 Global Aggregated Cases and Deaths by Country

```{r message=FALSE}
agg.gloabl = covid19.data("aggregated")
agg.gloabl = agg.gloabl %>%
  select(Country_Region, Confirmed, Deaths) %>%
  group_by(Country_Region) %>%
  summarise_all(funs(sum)) %>%
  arrange(desc(Confirmed))
head(agg.gloabl)
```

### 1.4 U.S. Aggregated Cases and Deaths By State

```{r message=FALSE}
agg.us = covid19.data("aggregated")
agg.us = agg.us %>%
  filter(Country_Region == "US" & Province_State != "Recovered") %>%
  select(Province_State, Confirmed, Deaths) %>%
  group_by(Province_State) %>%
  summarise_all(funs(sum)) %>%
  arrange(desc(Confirmed))
head(agg.us)
```

### 1.5 U.S. Active Cases, Deaths and Recovered Time-Series

```{r}
ts.us.all = covid19.data("ts-ALL") %>%
  filter(Country.Region == "US") %>%
  select(-c(Province.State, Country.Region, Long, Lat)) %>%
  group_by(status) %>%
  summarise_all(funs(sum))
ts.us.all = as_tibble(t(as.matrix(ts.us.all)))
colnames(ts.us.all) = unlist(ts.us.all[1,])
ts.us.all = ts.us.all[-1,]
ts.us.all$confirmed = as.integer(ts.us.all$confirmed)
ts.us.all$death = as.integer(ts.us.all$death)
ts.us.all$recovered = as.integer(ts.us.all$recovered)
ts.us.all = ts.us.all %>% mutate(active = confirmed - death - recovered)
head(ts.us.all)
```


## 2. Exploratory Analysis

### 2.1 World Map of Confirmed Cases and Deaths
```{r}
world_map <- map_data("world")
agg.gloabl.map = agg.gloabl
agg.gloabl.map$Country_Region = as.character(agg.gloabl$Country_Region)
agg.gloabl.map$Country_Region[agg.gloabl.map$Country_Region == "US"] = "USA"
agg.gloabl.map$Country_Region[agg.gloabl.map$Country_Region == "United Kingdom"] = "UK"
agg.gloabl.map$Country_Region[agg.gloabl.map$Country_Region == "Korea, South"] = "South Korea"
agg.gloabl.map$Country_Region[agg.gloabl.map$Country_Region == "Taiwan*"] = "Taiwan"

agg.gloabl.map <- inner_join(agg.gloabl.map, world_map, by = c("Country_Region" = "region"))
```

```{r}
ggplotly(
  ggplot(agg.gloabl.map, aes(long, lat, group = group, fill = Confirmed, text = paste0(Country_Region, "\n", "Confirmed Cases:", Confirmed))) +
    scale_fill_gradient(low = "gray99", high = "coral3") +
    geom_polygon(), tooltip = c("text")
         )

ggplotly(
  ggplot(agg.gloabl.map, aes(long, lat, group = group, fill = log(Confirmed), text = paste0(Country_Region, "\n", "Confirmed Cases:", Confirmed))) +
    scale_fill_gradient(low = "gray99", high = "coral3") +
    geom_polygon(), tooltip = c("text")
         )
```


```{r}
ggplotly(
  ggplot(agg.gloabl.map, aes(long, lat, group = group, fill = Deaths, text = paste0(Country_Region, "\n", "Deaths:", Deaths))) +
    scale_fill_gradient(low = "gray99", high = "coral3") +
    geom_polygon(), tooltip = c("text")
         )

ggplotly(
  ggplot(agg.gloabl.map, aes(long, lat, group = group, fill = log(Deaths), text = paste0(Country_Region, "\n", "Deaths:", Deaths))) +
    scale_fill_gradient(low = "gray99", high = "coral3") +
    geom_polygon(), tooltip = c("text")
         )
```

### 2.2 US Map of Confirmed Cases and Deaths

```{r}
states_map = map_data("state")
agg.us.map = agg.us %>% mutate(Province_State = tolower(Province_State))
agg.us.map = inner_join(agg.us.map, states_map, by = c("Province_State" = "region"))
```

```{r}
ggplotly(
  ggplot(agg.us.map, aes(long, lat, group = group, fill = Confirmed, text = paste0(Province_State, "\n", "Confirmed Cases:", Confirmed))) +
    scale_fill_gradient(low = "gray99", high = "coral3") +
    geom_polygon(), tooltip = c("text")
         )

ggplotly(
  ggplot(agg.us.map, aes(long, lat, group = group, fill = log(Confirmed), text = paste0(Province_State, "\n", "Confirmed Cases:", Confirmed))) +
    scale_fill_gradient(low = "gray99", high = "coral3") +
    geom_polygon(), tooltip = c("text")
         )
```

```{r}
ggplotly(
  ggplot(agg.us.map, aes(long, lat, group = group, fill = Deaths, text = paste0(sapply(Province_State, Caps), "\n", "Deaths:", Deaths))) +
    scale_fill_gradient(low = "gray99", high = "coral3") +
    geom_polygon(), tooltip = c("text")
         )

ggplotly(
  ggplot(agg.us.map, aes(long, lat, group = group, fill = log(Deaths), text = paste0(sapply(Province_State, Caps), "\n", "Deaths:", Deaths))) +
    scale_fill_gradient(low = "gray99", high = "coral3") +
    geom_polygon(), tooltip = c("text")
         )
```

### 2.3 Global Time-Series Plot (Top 10 Countries)

```{r}
top10_countries = ts.confirmed$Country.Region[1:10]
ts.confirmed.top10 = ts.confirmed %>% filter(Country.Region %in% top10_countries)
df.global.ts = tibble()
n_days = 100
for(i in c(1:10)) {
  # get the variables
  Count = unlist(ts.confirmed.top10[i,-1])[unlist(ts.confirmed.top10[i,-1]) > n_days]
  Day = c(1:length(Count))
  Country = rep(top10_countries[i], length(Count))
  # append to the pre-specified table
  df.new = tibble(Country, Day, Count)
  df.global.ts = rbind(df.global.ts, df.new)
}
```

```{r}
ggplotly(
  ggplot(df.global.ts, aes(Day, Count, group = Country, color = Country, 
                         text = paste0(Country, "\n", "Total Cases:", Count))) +
    geom_line() +
    ggtitle("Global Total Confirmed Cases (Top 10 Countries)") +
    xlab("Days After 100 Cases") +
    ylab("Total Confirmed Cases"), tooltip = c("text")
  )

```

### 2.4 U.S. Time-Series Plot (Top 10 States)

```{r}
top10_states = ts.us %>% group_by(State) %>% summarise(max = max(Confirmed)) %>% 
  arrange(desc(max)) %>% select(State)
top10_states = top10_states$State[1:10]
```


```{r}
ggplotly(
  ggplot(ts.us %>% filter(State %in% top10_states), aes(Date, Confirmed, group = State, color = State,
                                                        text = paste0(State, "\n", "Total Cases:", Confirmed))) +
    geom_line() +
    ggtitle("U.S. Total Confirmed Cases (Top 10 States)") +
    xlab("Date") +
    ylab("Total Confirmed Cases"), tooltip = c("text")
  )
```

### 2.5 World Trend

```{r}
ts.world = colSums(ts.confirmed[,-1])
ts.world = tibble("Date" = names(ts.world), "Count" = ts.world)
ts.world$Date = as.Date(ts.world$Date)
ts.world$New = c(NA, diff(ts.world$Count))
coeff = tail(ts.world$Count, 1)/tail(ts.world$New, 1)
newColor = "black"
countColor = "darkorange"

moving_n = 10
ggplot(ts.world, aes(x=Date)) +
  geom_line(aes(y=New), color=newColor, alpha = 0.2) +
  geom_ma(aes(y=New), ma_fun = SMA, n = moving_n, color=newColor) +
  geom_bar(aes(y=Count/coeff), stat="identity", fill=countColor, color=countColor, alpha=.2) + 
  
  scale_y_continuous(
    
    # Features of the first axis
    name = "Number of New Cases",
    
    # Add a second axis and specify its features
    sec.axis = sec_axis(~.*coeff, name="Total Confirmed Cases")
  ) + 
  
  
  theme(
    axis.title.y = element_text(color = newColor, size=11),
    axis.title.y.right = element_text(color = countColor, size=11)
  )
```

### 2.6 U.S. Trend

```{r}
ts.us.confirmed = unlist(ts.confirmed[1, -1])
ts.us.confirmed = tibble("Date" = names(ts.us.confirmed), "Count" = ts.us.confirmed)
ts.us.confirmed$Date = as.Date(ts.us.confirmed$Date)
ts.us.confirmed$New = c(NA, diff(ts.us.confirmed$Count))
coeff = tail(ts.us.confirmed$Count, 1)/tail(ts.us.confirmed$New, 1)

ggplot(ts.us.confirmed, aes(x=Date)) +
  geom_line(aes(y=New), color=newColor, alpha = 0.2) +
  geom_ma(aes(y=New), ma_fun = SMA, n = moving_n, color=newColor) +
  geom_bar(aes(y=Count/coeff), stat="identity", fill=countColor, color=countColor, alpha=.2) + 
  
  scale_y_continuous(
    
    # Features of the first axis
    name = "Number of New Cases",
    
    # Add a second axis and specify its features
    sec.axis = sec_axis(~.*coeff, name="Total Confirmed Cases")
  ) + 
  
  
  theme(
    axis.title.y = element_text(color = newColor, size=11),
    axis.title.y.right = element_text(color = countColor, size=11)
  )
```

## 3. U.S. COVID-19 Analysis and Prediction

### 3.1 U.S. Growth Rate

```{r}
data = covid19.data("ts-confirmed")
growth.rate(data, geo.loc="US")
```

### 3.2 SEIRD Model Simulation in the U.S.
#### 3.2.1 Model Tuning

```{r}
SEIRD = function(S0, E0, I0, R0, D0, alpha1, alpha2, c1, c2, beta1, gamma1, eta1, n1) {
  Out1 = matrix(0, ncol = 5, nrow = n1) # Output container
  for(i in 1:n1) {
    S0n = S0
    I0n = I0
    R0n = R0
    E0n = E0
    D0n = D0
    ind1 = ifelse(i > c1, 1, 0) # intervetion
    ind2 = ifelse(i > c2, 1, 0) # intervetion
    S0 = max(0, S0n - (alpha1 + alpha2*ind1 + log(i)*0.0675*alpha2*ind2)*I0n*S0n)
    E0 = max(0, E0 + (alpha1 + alpha2*ind1 + log(i)*0.0675*alpha2*ind2)*I0n*S0n - gamma1*E0n)
    I0 = max(0, I0n + gamma1*E0n - beta1*I0n - eta1*I0n)
    R0 = max(0, R0n + beta1*I0n)
    D0 = max(0, D0n + eta1*I0n)
    Out1[i,1] = S0
    Out1[i,2] = I0
    Out1[i,3] = R0
    Out1[i,4] = E0
    Out1[i,5] = D0
  }
  Out2 = tibble(S = Out1[,1],
                I = Out1[,2],
                R = Out1[,3],
                E = Out1[,4],
                D = Out1[,5])
  return(Out2)
}

# SEIRD Model Parameter Tuning
S0 = 327200000 # Initial susceptible
I0 = 1 # Initial infected
R0 = 0 # Initial recovered
E0 = 10 # Initial exposed
D0 = 0 # Initial death

alpha1 = 1/860000000 # S - > E
alpha2 = -1/1250000000 # Intervention
beta1 = 1/140 # I -> R
gamma1 = 1/7 # E -> I
eta1 = 1/230 # I -> D
n1 = nrow(ts.us.all)

Out1 = SEIRD(S0, E0, I0, R0, D0, alpha1, alpha2, 70, 82, beta1, gamma1, eta1, n1)

plot(1:n1, Out1$I, col = "orange", main = "Infected", xlab="Days", ylab="Cases")
lines(1:n1, ts.us.all$active, col = "orange")

plot(1:n1, Out1$D, col = "red", main = "Deaths", xlab="Days", ylab="Cases")
lines(1:n1, ts.us.all$death, col = "red")

plot(1:n1, Out1$R, col = "green",  main = "Recovered", xlab="Days", ylab="Cases")
lines(1:n1, ts.us.all$recovered, col = "green")
```

#### 3.2.2 1000 Days Simulation

```{r}
SEIRD = function(S0, E0, I0, R0, D0, alpha1, alpha2, c1, c2, beta1, gamma1, eta1, n1) {
  Out1 = matrix(0, ncol = 5, nrow = n1) # Output container
  for(i in 1:n1) {
    S0n = S0
    I0n = I0
    R0n = R0
    E0n = E0
    D0n = D0
    ind1 = ifelse(i > c1, 1, 0) # intervetion
    ind2 = ifelse(i > c2, 1, 0) # intervetion
    S0 = max(0, S0n - (alpha1 + alpha2*ind1 + log(i)*0.081*alpha2*ind2)*I0n*S0n)
    E0 = max(0, E0 + (alpha1 + alpha2*ind1 + log(i)*0.081*alpha2*ind2)*I0n*S0n - gamma1*E0n)
    I0 = max(0, I0n + gamma1*E0n - beta1*I0n - eta1*I0n)
    R0 = max(0, R0n + beta1*I0n)
    D0 = max(0, D0n + eta1*I0n)
    Out1[i,1] = S0
    Out1[i,2] = I0
    Out1[i,3] = R0
    Out1[i,4] = E0
    Out1[i,5] = D0
  }
  Out2 = tibble(S = Out1[,1],
                I = Out1[,2],
                R = Out1[,3],
                E = Out1[,4],
                D = Out1[,5])
  return(Out2)
}

# Simulation for 1000 days
n2 = n1+1000
Out1 = SEIRD(S0, E0, I0, R0, D0, alpha1, alpha2, 70, 82, beta1, gamma1, eta1, n2)

plot(1:n2, Out1$I, col = "orange", main = "SEIRD Simulation", xlab="Days", ylab="Cases", ylim = c(0, 1500000), type = "l")
lines(1:n2, Out1$D, col = "red", xlab="Days", ylab="Cases", type = "l")
lines(1:n2, Out1$R, col = "green", xlab="Days", ylab="Cases", type = "l")
```

```{r}

```

```{r}

```


```{r}

```

```{r}

```

```{r}

```